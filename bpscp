#!/bin/bash

# Define the target server address and destination path
TARGET_SERVER=$2
DESTINATION_PATH=$3
SOURCE_PATH=$1

# Log file to track transferred files
TRANSFER_LOG="transfer_log.txt"

# Check if log file exists, if not, create it
[ -f $TRANSFER_LOG ] || touch $TRANSFER_LOG

# Iterate through all files in the source directory
for FILE in $SOURCE_PATH/*
do
    # Extract just the filename
    FILE_NAME=$(basename "$FILE")

    # Check if the file is already transferred
    if grep -Fxq "$FILE_NAME" $TRANSFER_LOG; then
        echo "$FILE_NAME already transferred. Skipping."
        continue
    fi

    # SCP command to transfer the file
    scp "$FILE" $TARGET_SERVER:$DESTINATION_PATH

    # Check if SCP transfer was successful
    if [ $? -eq 0 ]; then
        echo "$FILE_NAME" >> $TRANSFER_LOG
        echo "Transferred $FILE_NAME successfully."
    else
        echo "Failed to transfer $FILE_NAME."
    fi
done

